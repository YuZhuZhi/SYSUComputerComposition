# 第四次实验——流水灯

## 一、实验目的

1.使用`Verilog`编写流水灯，并在开发板上实现。

2.实现方向控制、速度控制。

---

## 二、实验过程

### 1.实现流水显示——`Display.v`

流水显示是这个实验的基础。下面两张图是代码截图：

<image src="/image/4/Display1.jpg">

<image src="/image/4/Display2.jpg">

基本思路是，`Display`模块要能根据方向选择选择流水方向。其流水显示的更新时间由输入的`CLK_in`决定。唯一的输出就是指定要亮哪一个灯。

由于方向有三个——即向前、向后、暂停，因此方向变量`Dir`需要两位。这里我这样规定：如果第一位是`0`，那么表示暂停；否则，若第二位为`0`，那么向左流动；若第二位为`1`，那么向右流动。

由于总共有`16`个灯，所以记录要亮起的灯的编号`Num`至少需要四位。由`Dir`决定`Num`如何变化。

每有信号改变，就更新一次灯亮起的状态。输出的十六位`Light`变量，每一位上若为`1`就代表其指示的灯要亮起。这样，要想实现流水效果，就应该由前到后依次设置一位为`1`，如图所示。

### 2.实现方向选择——`Direct.v`

方向选择决定了流水线显示的方向。这个模块负责根据按下的方向选择键输出方向。

显然，三个方向对应三个按钮即三个一位输入，以及一个方向选择输出的两位信号`Dir_Sel`。代码如下截图所示：

<image src="/image/4/Direct.jpg">

每当有一次按钮按下，就更新`temp`的值，并赋值给输出信号`Dir_Sel`。

这里，指定左按钮是向左流动，下按钮是暂停，右按钮是向右流动。

### 3.实现速度调控——`CLK_Div.v`

因为`Display.v`是根据输入的时钟信号更新显示的，因此要想调控速度，就要从输入的时钟信号下手。这与之前做的分频器是相似的。代码截图如下：

<image src="/image/4/CLK_Div1.jpg">

<image src="/image/4/CLK_Div2.jpg">

这里，我实现的是四档速度控制，由两个拨板开关实现。其原理是由输入的速度档位决定`Counter`的上限值`MAX`，每当`Counter`累计到`MAX`就将输出反相一次并将`Counter`归零。

### 4.模块联合——`(top) FluentLight.v`

以上三个是基本模块。现在`top`文件中统筹之。代码截图如下：

<image src="/image/4/FluentLight1.jpg">

<image src="/image/4/FluentLight2.jpg">

`Direct` `CLK_Div`模块为`Display`提供输入，故只需要两个`wire`连线，即`CLK_wire` `[1 : 0] Dir_wire`。将每个变量对应即可。

### 5.约束文件——`FluentLight.xdc`

约束文件代码如下：

<image src="/image/4/Cons.jpg">

将`[15 : 0] light`直接每一位对应开发板上一个对应编号的`LED`。

`[1 : 0] speed`速度选择由最右边两个拨板开关约束。

`Button_Left` `Button_Down` `Button_Right`即是开发板上方向键的左、下、右。

---

## 三、实验效果

在默认状态下，流水灯从右往左，以最快速度流动。

<image src="/image/4/FL1.gif">

通过按下方向键，可以改变流动方向。

<image src="/image/4/FL2.gif">
